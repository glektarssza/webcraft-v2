# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build
on:
  push:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build-configuration:
        type: choice
        required: false
        options:
          - development
          - production
        default: production
        description: |
          The type of build to create.

          Valid options are:
           * `development`: Create a development/debugging build.
           * `production`: Create a production-ready build.
  workflow_call:
    inputs:
      ref:
        type: string
        required: true
        description: |
          The Git reference to build against.
      build-configuration:
        type: string
        required: false
        default: production
        description: |
          The type of build to create.

          Valid options are:
           * `development`: Create a development/debugging build.
           * `production`: Create a production-ready build.
    secrets:
      github-token:
        description: |
          The token to use to make authenticated requests to the GitHub API.
        required: false
jobs:
  build:
    name: build-${{matrix.build-configuration}}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{github.token}}
    permissions:
      # -- Required to clone repository
      contents: read
      # -- Required to create/update checks
      checks: write
    strategy:
      fail-fast: true
      matrix:
        build-configuration:
          - development
          - production
        exclude:
          - build-configuration: ${{inputs.build-configuration == 'development' && 'production' || ''}}
          - build-configuration: ${{inputs.build-configuration == 'production' && 'development' || ''}}
    outputs:
      artifact-id: ${{steps.upload-artifacts.outputs.artifact-id}}
      artifact-name: dist-${{matrix.build-configuration}}
      artifact-url: ${{steps.upload-artifacts.outputs.artifact-url}}
    steps:
      - id: checkout-repository
        name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{inputs.ref || github.ref}}
          fetch-tags: true
          lfs: true
          submodules: true
          show-progress: true
          token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
      - id: setup-pnpm
        name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          package_json_file: ./package.json
          run_install: false
          standalone: false
      - id: setup-nodejs
        name: Setup NodeJS
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml
          token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
      - id: install-dependencies
        name: Install dependencies
        run: pnpm -r install
      - id: build-scripts
        name: Build scripts
        run: pnpm -r --filter=@webcraft/github-actions-scripts run build
      - id: extract-job-ids
        name: Get job ID
        uses: actions/github-script@v8
        with:
          github-token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
          result-encoding: json
          script: |
            const {script} = require("./.github/scripts/dist/prod/get-job-id.js");
            await script({
              github, context, core, glob, io, exec
            }, {
              jobName: "build-${{matrix.build-configuration}}"
            });
      - id: find-existing-check-runs
        name: Find existing check runs
        uses: actions/github-script@v8
        with:
          github-token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
          result-encoding: json
          script: |
            const {script} = require("./.github/scripts/dist/prod/find-existing-check-runs.js");
            await script({
              github, context, core, glob, io, exec
            }, {
              headRef: "${{inputs.ref}}",
              jobId: "${{steps.extract-job-ids.outputs.job-id}}"
            });
      - id: create-check-run
        name: Start check run
        if: steps.find-existing-check-runs.outputs.has-existing-check-run != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
          result-encoding: json
          script: |
            const {script} = require("./.github/scripts/dist/prod/create-check-run.js");
            const dateStr = new Date().toISOString();
            await script({
              github, context, core, glob, io, exec
            }, {
              headRef: "${{inputs.ref}}",
              jobId: "${{steps.extract-job-ids.outputs.job-id}}",
              checkName: "Build:${{matrix.build-configuration}}",
              checkTitle: "GitHub Actions CI - Build:${{matrix.build-configuration}}",
              checkSummary: `The job \`Build:${{matrix.build-configuration}}\` has started at \`${dateStr}\`.`,
              checkText: `The job \`Build:${{matrix.build-configuration}}\` (job ID \`${{steps.extract-job-ids.outputs.job-id}}\`) has started at \`${dateStr}\`.

              We are waiting for it to complete.`
            });
      - id: build
        name: Build
        run: pnpm --filter=webcraft run build:${{matrix.build-configuration}}
      - id: upload-artifacts
        name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-app-${{matrix.build-configuration}}
          path: ./app/dist/
          if-no-files-found: error
      - id: finish-check-run
        name: Finish check run
        if: always() && steps.checkout-repository.outcome == 'success' && (steps.find-existing-check-runs.outputs.has-existing-check-run || steps.create-check-run.outputs.has-existing-check-run)
        uses: actions/github-script@v8
        with:
          github-token: ${{secrets.github-token || secrets.GITHUB_TOKEN}}
          result-encoding: json
          script: |
            const {script} = require("./.github/scripts/dist/prod/finish-check-run.js");
            const dateStr = new Date().toISOString();
            await script({
              github, context, core, glob, io, exec
            }, {
              headRef: "${{inputs.ref}}",
              checkRunId: "${{steps.find-existing-check-runs.outputs.check-run-id || steps.create-check-run.outputs.check-run-id}}",
              checkName: "Build:${{matrix.build-configuration}}",
              checkTitle: "GitHub Actions CI - Build:${{matrix.build-configuration}}",
              checkSummary: `The job \`Build:${{matrix.build-configuration}}\` has finished at \`${dateStr}\` with a status of \`${{job.status}}\`.`,
              checkText: `The job \`Build:${{matrix.build-configuration}}\` (job ID \`${{steps.extract-job-ids.outputs.job-id}}\`) has finished at \`${dateStr}\`

              It's conclusion was \`${{job.status}}\`.`,
              checkConclusion: "${{job.status}}"
            });
